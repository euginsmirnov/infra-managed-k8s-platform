---
- name: Online Boutique demo secret (Vault -> ESO -> K8s Secret -> frontend env)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ansible_python_interpreter: /home/sega/infra-managed-k8s-platform/.venv/bin/python
    kubeconfig: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"

    ob_namespace: online-boutique

    # ExternalSecret will create this Kubernetes Secret
    ob_demo_secret_name: ob-frontend-demo

    # Manifest path in repo
    ob_externalsecret_manifest: "{{ playbook_dir }}/../../../platform/online-boutique/externalsecret-frontend-demo.yaml"

  tasks:
    - name: Apply ExternalSecret for frontend demo message
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ ob_externalsecret_manifest }}"

    - name: Wait for Kubernetes Secret created by ESO
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ ob_namespace }}"
        name: "{{ ob_demo_secret_name }}"
      register: demo_secret
      retries: 60
      delay: 2
      until: demo_secret.resources | length == 1

    - name: Patch frontend deployment to consume DEMO_MESSAGE from secret
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        merge_type:
          - strategic-merge
          - merge
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: "{{ ob_namespace }}"
          spec:
            template:
              spec:
                containers:
                  - name: server
                    env:
                      - name: DEMO_MESSAGE
                        valueFrom:
                          secretKeyRef:
                            name: "{{ ob_demo_secret_name }}"
                            key: demo_message

    - name: Wait for frontend rollout after env patch
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ ob_namespace }}"
        name: frontend
      register: frontend_dep
      retries: 60
      delay: 5
      until: >
        frontend_dep.resources | length == 1 and
        (frontend_dep.resources[0].status.availableReplicas | default(0)) >= 1

    - name: Read demo secret (via k8s API, not kubectl)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ ob_namespace }}"
        name: "{{ ob_demo_secret_name }}"
      register: demo_secret_read

    - name: Print demo secret decoded value
      ansible.builtin.debug:
        msg: >-
          DEMO_MESSAGE (decoded) =
          {{ demo_secret_read.resources[0].data.demo_message | b64decode }}
