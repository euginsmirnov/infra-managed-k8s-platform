---
- name: Install Vault (raft, ingress, cert-manager tls) and bootstrap auth
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"

    vault_namespace: vault
    vault_release: vault
    vault_chart_ref: hashicorp/vault
    vault_chart_version: ""     # можно зафиксировать

    vault_values_file: "{{ playbook_dir }}/../../platform/vault/values.yaml"
    vault_hostname: vault.ejara1.ru
    vault_tls_secret: vault-tls

    # Bootstrap toggle
    vault_bootstrap_enabled: true
    vault_bootstrap_script: "{{ playbook_dir }}/../../platform/vault/bootstrap/vault-bootstrap.sh"

    # Где хранить root token / unseal keys — НЕ в кластере.
    # На MVP bootstrap будет требовать VAULT_TOKEN извне (после init/unseal).
    # Секреты в git не кладём.
    vault_addr: "https://{{ vault_hostname }}"

    repo_name: hashicorp
    repo_url: https://helm.releases.hashicorp.com

  tasks:
    - name: Ensure vault namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ vault_namespace }}"

    - name: Add hashicorp helm repo (idempotent)
      kubernetes.core.helm_repository:
        name: "{{ repo_name }}"
        repo_url: "{{ repo_url }}"

    - name: Install/upgrade Vault via Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ vault_release }}"
        chart_ref: "{{ vault_chart_ref }}"
        chart_version: "{{ vault_chart_version | default(omit) }}"
        release_namespace: "{{ vault_namespace }}"
        create_namespace: false
        wait: true
        atomic: true
        values_files:
          - "{{ vault_values_file }}"

    - name: Wait for Vault pod to be Ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Pod
        namespace: "{{ vault_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=vault"
      register: vault_pods
      retries: 60
      delay: 5
      until: >
        (vault_pods.resources | length) >= 1 and
        (
          vault_pods.resources[0].status.conditions | selectattr('type','equalto','Ready')
          | selectattr('status','equalto','True') | list | length
        ) == 1

    - name: Wait for Vault TLS secret to appear (cert-manager)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ vault_namespace }}"
        name: "{{ vault_tls_secret }}"
      register: tls_secret
      retries: 60
      delay: 5
      until: tls_secret.resources | length == 1

    - name: (Optional) Create bootstrap ConfigMap with script
      when: vault_bootstrap_enabled
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: vault-bootstrap-script
            namespace: "{{ vault_namespace }}"
          data:
            vault-bootstrap.sh: "{{ lookup('file', vault_bootstrap_script) }}"

    - name: (Optional) Create bootstrap Job (requires VAULT_TOKEN provided at runtime)
      when: vault_bootstrap_enabled
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: vault-bootstrap
            namespace: "{{ vault_namespace }}"
          spec:
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: bootstrap
                    image: hashicorp/vault:1.16.0
                    env:
                      - name: VAULT_ADDR
                        value: "{{ vault_addr }}"
                      # VAULT_TOKEN мы НЕ храним в кластере.
                      # Перед запуском job ты создашь secret vault-bootstrap-token вручную
                      # (или через отдельный плейбук, который читает токен из vault_token_file на ansible-host).
                      - name: VAULT_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: vault-bootstrap-token
                            key: token
                    volumeMounts:
                      - name: script
                        mountPath: /scripts
                    command: ["/bin/sh","-lc"]
                    args:
                      - "chmod +x /scripts/vault-bootstrap.sh && /scripts/vault-bootstrap.sh"
                volumes:
                  - name: script
                    configMap:
                      name: vault-bootstrap-script
                      defaultMode: 0755
