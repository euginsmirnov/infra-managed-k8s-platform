---
- name: Install Vault (raft, ingress, cert-manager tls) and bootstrap auth
  hosts: localhost
  connection: local

  gather_facts: false

  vars:
    kubeconfig: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"
    ansible_python_interpreter: /home/sega/infra-managed-k8s-platform/.venv/bin/python
    vault_namespace: vault
    vault_release: vault
    vault_chart_ref: hashicorp/vault
    vault_chart_version: ""     # можно зафиксировать

    vault_values_file: "{{ playbook_dir }}/../../../platform/vault/values.yaml"
    vault_hostname: vault.ejara1.ru
    vault_tls_secret: vault-tls

    # Bootstrap toggle
    vault_bootstrap_enabled: true
    vault_bootstrap_script: "{{ playbook_dir }}/../../../platform/vault/bootstrap/vault-bootstrap.sh"

    # Адрес Vault (через ingress)
    vault_addr: "https://{{ vault_hostname }}"

    repo_name: hashicorp
    repo_url: https://helm.releases.hashicorp.com

  tasks:
    - name: Ensure vault namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ vault_namespace }}"

    - name: Add hashicorp helm repo (idempotent)
      kubernetes.core.helm_repository:
        name: "{{ repo_name }}"
        repo_url: "{{ repo_url }}"

    - name: Install/upgrade Vault via Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ vault_release }}"
        chart_ref: "{{ vault_chart_ref }}"
        chart_version: "{{ vault_chart_version | default(omit) }}"
        release_namespace: "{{ vault_namespace }}"
        create_namespace: false
        wait: true
        atomic: true
        values_files:
          - "{{ vault_values_file }}"

    - name: Apply Vault Ingress (managed by platform repo)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ playbook_dir }}/../../../platform/vault/ingress.yaml"

    - name: Wait for Vault pod to be Running
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Pod
        namespace: "{{ vault_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=vault"
      register: vault_pods
      retries: 60
      delay: 5
      until: >
        (vault_pods.resources | length) >= 1 and
        (vault_pods.resources[0].status.phase == "Running")

    - name: Wait for Vault TLS secret to appear (cert-manager)
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ vault_namespace }}"
        name: "{{ vault_tls_secret }}"
      register: tls_secret
      retries: 60
      delay: 5
      until: tls_secret.resources | length == 1

    - name: Apply Vault auth reviewer RBAC
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ playbook_dir }}/../../../platform/vault/rbac-vault-auth.yaml"

    - name: Check if vault-bootstrap-token secret exists
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ vault_namespace }}"
        name: vault-bootstrap-token
      register: bootstrap_token_secret

    - name: Decide whether bootstrap should run
      ansible.builtin.set_fact:
        bootstrap_should_run: "{{ vault_bootstrap_enabled and (bootstrap_token_secret.resources | length == 1) }}"

    - name: Bootstrap skipped (vault-bootstrap-token secret not found)
      ansible.builtin.debug:
        msg: "Skipping vault bootstrap job because secret 'vault-bootstrap-token' is missing. Create it after init/unseal, then rerun make vault."
      when: vault_bootstrap_enabled and not bootstrap_should_run

    - name: (Optional) Create bootstrap ConfigMap with script
      when: vault_bootstrap_enabled
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: vault-bootstrap-script
            namespace: "{{ vault_namespace }}"
          data:
            vault-bootstrap.sh: |
              {{ lookup('file', vault_bootstrap_script) | indent(14) }}

    - name: (Optional) Delete previous bootstrap Job if exists
      when: bootstrap_should_run
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: absent
        kind: Job
        namespace: "{{ vault_namespace }}"
        name: vault-bootstrap

    - name: (Optional) Create bootstrap Job (requires VAULT_TOKEN secret created manually)
      when: bootstrap_should_run
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: vault-bootstrap
            namespace: "{{ vault_namespace }}"
          spec:
            backoffLimit: 1
            template:
              metadata:
                labels:
                  app: vault-bootstrap
              spec:
                restartPolicy: Never
                serviceAccountName: vault-auth
                containers:
                  - name: bootstrap
                    image: hashicorp/vault:1.21.2
                    imagePullPolicy: IfNotPresent
                    env:
                      - name: VAULT_ADDR
                        value: "{{ vault_addr }}"
                      - name: VAULT_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: vault-bootstrap-token
                            key: token
                    volumeMounts:
                      - name: script
                        mountPath: /scripts
                        readOnly: true
                    command: ["sh", "-lc"]
                    args:
                      - |
                        set -eu
                        echo "[*] Waiting for Vault..."
                        for i in $(seq 1 60); do
                          if vault status >/dev/null 2>&1; then
                            echo "[+] Vault is reachable"
                            break
                          fi
                          sleep 2
                        done
                        echo "[*] Running bootstrap script"
                        sh /scripts/vault-bootstrap.sh
                volumes:
                  - name: script
                    configMap:
                      name: vault-bootstrap-script
                      defaultMode: 0444
