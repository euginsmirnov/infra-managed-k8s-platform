---
- name: Apply ESO demo ExternalSecret and verify sync
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"
    demo_namespace: demo
    external_secret_name: demo-hello
    k8s_secret_name: demo-hello

  tasks:
    - name: Ensure demo namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ demo_namespace }}"

    - name: Apply demo ExternalSecret (demo-hello)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ playbook_dir }}/../../../platform/external-secrets/externalsecret-demo-hello.yaml"

    - name: Wait for Kubernetes Secret to be created by ESO
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: "{{ demo_namespace }}"
        name: "{{ k8s_secret_name }}"
      register: synced_secret
      retries: 60
      delay: 2
      until: synced_secret.resources | length == 1

    - name: Assert secret has key 'value'
      ansible.builtin.assert:
        that:
          - synced_secret.resources[0].data.value is defined
        fail_msg: "Secret '{{ k8s_secret_name }}' created but key 'value' is missing."
        success_msg: "ESO demo secret synced successfully."