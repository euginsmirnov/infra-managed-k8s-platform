---
- name: Install External Secrets Operator (ESO) and Vault ClusterSecretStore
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ansible_python_interpreter: /home/sega/infra-managed-k8s-platform/.venv/bin/python
    kubeconfig: "{{ lookup('env','KUBECONFIG') | default('~/.kube/config', true) }}"

    eso_namespace: external-secrets
    eso_release: external-secrets
    eso_chart_ref: external-secrets/external-secrets
    eso_values_file: "{{ playbook_dir }}/../../../platform/external-secrets/values.yaml"

    repo_name: external-secrets
    repo_url: https://charts.external-secrets.io

  tasks:
    - name: Ensure external-secrets namespace exists
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ eso_namespace }}"

    - name: Add external-secrets helm repo (idempotent)
      kubernetes.core.helm_repository:
        name: "{{ repo_name }}"
        repo_url: "{{ repo_url }}"

    - name: Install/upgrade External Secrets Operator via Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: "{{ eso_release }}"
        chart_ref: "{{ eso_chart_ref }}"
        release_namespace: "{{ eso_namespace }}"
        create_namespace: false
        wait: true
        atomic: true
        values_files:
          - "{{ eso_values_file }}"

    - name: Wait for ESO deployments to be ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Deployment
        namespace: "{{ eso_namespace }}"
      register: eso_deploys
      retries: 60
      delay: 5
      until: >
        (eso_deploys.resources | length) >= 1 and
        (
          eso_deploys.resources
          | selectattr('status.availableReplicas','defined')
          | map(attribute='status.availableReplicas')
          | select('>=', 1)
          | list
          | length
        ) >= 1

    - name: Apply ClusterSecretStore for Vault
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        src: "{{ playbook_dir }}/../../../platform/external-secrets/clustersecretstore-vault.yaml"